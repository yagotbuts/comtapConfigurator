// vCard generation
        function generateVCard() {
            let vcard = 'BEGIN:VCARD\nVERSION:3.0\n';
            
            // Add production identifier
            vcard += 'PRODID:-//Comtap//Comtap Customizer 1.0//EN\n';
            
            // Add revision timestamp
            vcard += `REV:${new Date().toISOString().replace(/[-:]/g, '').split('.')[0]}Z\n`;
            
            // Names
            for (let i = 1; i <= recordCounters.name; i++) {
                const record = document.getElementById(`name-record-${i}`);
                if (record) {
                    const first = document.getElementById(`name-first-${i}`).value;
                    const last = document.getElementById(`name-last-${i}`).value;
                    const middle = document.getElementById(`name-middle-${i}`).value;
                    const prefix = document.getElementById(`name-prefix-${i}`).value;
                    const suffix = document.getElementById(`name-suffix-${i}`).value;
                    
                    if (first || last) {
                        vcard += `N:${last};${first};${middle};${prefix};${suffix}\n`;
                        vcard += `FN:${prefix} ${first} ${middle} ${last} ${suffix}`.replace(/\s+/g, ' ').trim() + '\n';
                    }
                }
            }
            
            // Nicknames
            for (let i = 1; i <= recordCounters.nickname; i++) {
                const record = document.getElementById(`nickname-record-${i}`);
                if (record) {
                    const nickname = document.getElementById(`nickname-value-${i}`).value;
                    if (nickname) {
                        vcard += `NICKNAME:${nickname}\n`;
                    }
                }
            }
            
            // Titles
            for (let i = 1; i <= recordCounters.title; i++) {
                const record = document.getElementById(`title-record-${i}`);
                if (record) {
                    const title = document.getElementById(`title-value-${i}`).value;
                    if (title) {
                        vcard += `TITLE:${title}\n`;
                    }
                }
            }
            
            // Roles
            for (let i = 1; i <= recordCounters.role; i++) {
                const record = document.getElementById(`role-record-${i}`);
                if (record) {
                    const role = document.getElementById(`role-value-${i}`).value;
                    if (role) {
                        vcard += `ROLE:${role}\n`;
                    }
                }
            }
            
            // Organizations
            for (let i = 1; i <= recordCounters.org; i++) {
                const record = document.getElementById(`org-record-${i}`);
                if (record) {
                    const name = document.getElementById(`org-name-${i}`).value;
                    const department = document.getElementById(`org-department-${i}`).value;
                    if (name) {
                        vcard += `ORG:${name}`;
                        if (department) {
                            vcard += `;${department}`;
                        }
                        vcard += '\n';
                    }
                }
            }
            
            // Categories
            for (let i = 1; i <= recordCounters.category; i++) {
                const record = document.getElementById(`category-record-${i}`);
                if<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>vCard Customizer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 2.5em;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .section {
            margin-bottom: 25px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }
        
        .section:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        .section-title {
            font-size: 1.3em;
            color: #2c3e50;
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        .add-button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        .add-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }
        
        .record {
            background: white;
            padding: 20px;
            margin: 15px 0;
            border-radius: 12px;
            border: 2px solid #e3f2fd;
            position: relative;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .record-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .remove-button {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }
        
        .remove-button:hover {
            transform: scale(1.05);
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e1e1;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .error {
            color: #e74c3c;
            font-size: 12px;
            margin-top: 5px;
        }
        
        .valid {
            border-color: #27ae60 !important;
        }
        
        .invalid {
            border-color: #e74c3c !important;
        }
        
        .address-lookup {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .generate-section {
            text-align: center;
            margin-top: 30px;
            padding: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            color: white;
        }
        
        .generate-button {
            background: white;
            color: #667eea;
            border: none;
            padding: 15px 40px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        .generate-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }
        
        .vcard-output {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 8px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        @media (max-width: 768px) {
            .two-column {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 20px;
            }
        }
        
        .lookup-results {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            position: absolute;
            width: 100%;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .lookup-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            transition: background 0.2s ease;
        }
        
        .lookup-item:hover {
            background: #f0f8ff;
        }
        
        .lookup-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Comtap Customizer</h1>
        
        <div id="vcard-form">
            <!-- Contact Information Sections -->
            <div class="section">
                <h3 class="section-title">Personal Name</h3>
                <div id="name-section">
                    <button class="add-button" onclick="addNameRecord()">Add Name</button>
                </div>
            </div>
            
            <div class="section">
                <h3 class="section-title">Phone Numbers</h3>
                <div id="phone-section">
                    <button class="add-button" onclick="addPhoneRecord()">Add Phone</button>
                </div>
            </div>
            
            <div class="section">
                <h3 class="section-title">Email Addresses</h3>
                <div id="email-section">
                    <button class="add-button" onclick="addEmailRecord()">Add Email</button>
                </div>
            </div>
            
            <div class="section">
                <h3 class="section-title">Addresses</h3>
                <div id="address-section">
                    <button class="add-button" onclick="addAddressRecord()">Add Address</button>
                </div>
            </div>
            
            <div class="section">
                <h3 class="section-title">Websites</h3>
                <div id="url-section">
                    <button class="add-button" onclick="addUrlRecord()">Add Website</button>
                </div>
            </div>
            
            <div class="section">
                <h3 class="section-title">Organizations</h3>
                <div id="org-section">
                    <button class="add-button" onclick="addOrgRecord()">Add Organization</button>
                </div>
            </div>
            
            <div class="section">
                <h3 class="section-title">Titles</h3>
                <div id="title-section">
                    <button class="add-button" onclick="addTitleRecord()">Add Title</button>
                </div>
            </div>
            
            <div class="section">
                <h3 class="section-title">Nicknames</h3>
                <div id="nickname-section">
                    <button class="add-button" onclick="addNicknameRecord()">Add Nickname</button>
                </div>
            </div>
            
            <div class="section">
                <h3 class="section-title">Roles</h3>
                <div id="role-section">
                    <button class="add-button" onclick="addRoleRecord()">Add Role</button>
                </div>
            </div>
            
            <div class="section">
                <h3 class="section-title">Categories</h3>
                <div id="category-section">
                    <button class="add-button" onclick="addCategoryRecord()">Add Category</button>
                </div>
            </div>
            
            <div class="section">
                <h3 class="section-title">Photos</h3>
                <div id="photo-section">
                    <button class="add-button" onclick="addPhotoRecord()">Add Photo</button>
                </div>
            </div>
            
            <div class="section">
                <h3 class="section-title">Logos</h3>
                <div id="logo-section">
                    <button class="add-button" onclick="addLogoRecord()">Add Logo</button>
                </div>
            </div>
            
            <div class="section">
                <h3 class="section-title">Sounds</h3>
                <div id="sound-section">
                    <button class="add-button" onclick="addSoundRecord()">Add Sound</button>
                </div>
            </div>
            
            <div class="section">
                <h3 class="section-title">Birthdate</h3>
                <div id="bday-section">
                    <button class="add-button" onclick="addBdayRecord()">Add Birthday</button>
                </div>
            </div>
            
            <div class="section">
                <h3 class="section-title">Anniversary</h3>
                <div id="anniversary-section">
                    <button class="add-button" onclick="addAnniversaryRecord()">Add Anniversary</button>
                </div>
            </div>
            
            <div class="section">
                <h3 class="section-title">Gender</h3>
                <div id="gender-section">
                    <button class="add-button" onclick="addGenderRecord()">Add Gender</button>
                </div>
            </div>
            
            <div class="section">
                <h3 class="section-title">Instant Messaging</h3>
                <div id="impp-section">
                    <button class="add-button" onclick="addImppRecord()">Add IM Contact</button>
                </div>
            </div>
            
            <div class="section">
                <h3 class="section-title">Geographic Location</h3>
                <div id="geo-section">
                    <button class="add-button" onclick="addGeoRecord()">Add Location</button>
                </div>
            </div>
            
            <div class="section">
                <h3 class="section-title">Time Zone</h3>
                <div id="tz-section">
                    <button class="add-button" onclick="addTzRecord()">Add Time Zone</button>
                </div>
            </div>
            
            <div class="section">
                <h3 class="section-title">Notes</h3>
                <div id="note-section">
                    <button class="add-button" onclick="addNoteRecord()">Add Note</button>
                </div>
            </div>
            
            <!-- Non-Contact Customizations -->
            <div class="section">
                <h3 class="section-title">Product Customizations</h3>
                <div id="custom-section">
                    <div class="record">
                        <div class="form-group">
                            <label>Backing Color</label>
                            <input type="color" id="backing-color" value="#000000">
                            <small style="color: #666; font-size: 12px;">Background color for the product</small>
                        </div>
                        <div class="form-group">
                            <label>Face Color</label>
                            <input type="color" id="face-color" value="#ffffff" onchange="validateFaceColor()">
                            <small style="color: #666; font-size: 12px;">Text/QR code color - must be brighter than backing color</small>
                            <div id="face-color-error" class="error" style="display: none;"></div>
                        </div>
                        <div class="form-group">
                            <label>Font</label>
                            <select id="font-family">
                                <option value="SF Pro Display" style="font-family: 'SF Pro Display', system-ui, -apple-system, sans-serif;">SF Pro Display</option>
                                <option value="SF Pro Text" style="font-family: 'SF Pro Text', system-ui, -apple-system, sans-serif;">SF Pro Text</option>
                                <option value="SF Compact Display" style="font-family: 'SF Compact Display', system-ui, -apple-system, sans-serif;">SF Compact Display</option>
                                <option value="SF Compact Text" style="font-family: 'SF Compact Text', system-ui, -apple-system, sans-serif;">SF Compact Text</option>
                                <option value="SF Mono" style="font-family: 'SF Mono', monospace;">SF Mono</option>
                                <option value="New York" style="font-family: 'New York', serif;">New York</option>
                                <option value="Helvetica Neue" style="font-family: 'Helvetica Neue', sans-serif;">Helvetica Neue</option>
                                <option value="Helvetica" style="font-family: 'Helvetica', sans-serif;">Helvetica</option>
                                <option value="Arial" style="font-family: 'Arial', sans-serif;">Arial</option>
                                <option value="Avenir Next" style="font-family: 'Avenir Next', sans-serif;">Avenir Next</option>
                                <option value="Avenir" style="font-family: 'Avenir', sans-serif;">Avenir</option>
                                <option value="Menlo" style="font-family: 'Menlo', monospace;">Menlo</option>
                                <option value="Monaco" style="font-family: 'Monaco', monospace;">Monaco</option>
                                <option value="Courier New" style="font-family: 'Courier New', monospace;">Courier New</option>
                                <option value="Times New Roman" style="font-family: 'Times New Roman', serif;">Times New Roman</option>
                                <option value="Times" style="font-family: 'Times', serif;">Times</option>
                                <option value="Palatino" style="font-family: 'Palatino', serif;">Palatino</option>
                                <option value="Georgia" style="font-family: 'Georgia', serif;">Georgia</option>
                                <option value="Trebuchet MS" style="font-family: 'Trebuchet MS', sans-serif;">Trebuchet MS</option>
                                <option value="Verdana" style="font-family: 'Verdana', sans-serif;">Verdana</option>
                                <option value="Futura" style="font-family: 'Futura', sans-serif;">Futura</option>
                                <option value="Optima" style="font-family: 'Optima', sans-serif;">Optima</option>
                                <option value="Gill Sans" style="font-family: 'Gill Sans', sans-serif;">Gill Sans</option>
                                <option value="Lucida Grande" style="font-family: 'Lucida Grande', sans-serif;">Lucida Grande</option>
                                <option value="Chalkboard SE" style="font-family: 'Chalkboard SE', fantasy;">Chalkboard SE</option>
                                <option value="Marker Felt" style="font-family: 'Marker Felt', fantasy;">Marker Felt</option>
                                <option value="Noteworthy" style="font-family: 'Noteworthy', fantasy;">Noteworthy</option>
                                <option value="Papyrus" style="font-family: 'Papyrus', fantasy;">Papyrus</option>
                                <option value="Brush Script MT" style="font-family: 'Brush Script MT', cursive;">Brush Script MT</option>
                                <option value="Zapfino" style="font-family: 'Zapfino', cursive;">Zapfino</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Preview</label>
                            <div id="color-preview" style="padding: 20px; border-radius: 8px; text-align: center; font-size: 18px; font-weight: bold; transition: all 0.3s ease;">
                                Sample Text / QR Code Area
                            </div>
                        </div>
                        <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 8px; margin-top: 15px;">
                            <strong>⚠️ Color Matching Disclaimer:</strong>
                            <p style="margin: 5px 0 0 0; font-size: 14px; color: #856404;">
                                Color matching will be performed to the best of our ability. Custom or currently unavailable color schemes may result in longer ordering and shipping times.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="generate-section">
                <button class="generate-button" onclick="generateVCard()">Generate vCard</button>
                <div id="vcard-output" class="vcard-output" style="display: none;"></div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let recordCounters = {
            name: 0,
            phone: 0,
            email: 0,
            address: 0,
            url: 0,
            org: 0,
            title: 0,
            note: 0,
            custom: 0,
            nickname: 0,
            role: 0,
            category: 0,
            photo: 0,
            logo: 0,
            sound: 0,
            bday: 0,
            anniversary: 0,
            gender: 0,
            impp: 0,
            geo: 0,
            tz: 0,
            key: 0
        };

        // Validation functions
        function validateEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }

        function validatePhone(phone) {
            const re = /^[\+]?[1-9][\d]{0,15}$/;
            return re.test(phone.replace(/[\s\-\(\)]/g, ''));
        }

        function validateUrl(url) {
            try {
                new URL(url);
                return true;
            } catch {
                return false;
            }
        }

        function showError(element, message) {
            element.classList.add('invalid');
            element.classList.remove('valid');
            let errorDiv = element.nextElementSibling;
            if (!errorDiv || !errorDiv.classList.contains('error')) {
                errorDiv = document.createElement('div');
                errorDiv.className = 'error';
                element.parentNode.insertBefore(errorDiv, element.nextSibling);
            }
            errorDiv.textContent = message;
        }

        function showValid(element) {
            element.classList.add('valid');
            element.classList.remove('invalid');
            let errorDiv = element.nextElementSibling;
            if (errorDiv && errorDiv.classList.contains('error')) {
                errorDiv.remove();
            }
        }

        // Address lookup function (mock implementation)
        function lookupAddress(query, callback) {
            // In a real implementation, you'd use a geocoding service like Google Maps API
            // This is a mock implementation
            setTimeout(() => {
                const mockResults = [
                    {
                        formatted: query + ", United States",
                        street: query.split(' ')[0] + " Street",
                        city: "Sample City",
                        state: "CA",
                        zip: "90210",
                        country: "United States"
                    }
                ];
                callback(mockResults);
            }, 500);
        }

        // Record creation functions
        function addNameRecord() {
            const id = ++recordCounters.name;
            const html = `
                <div class="record" id="name-record-${id}">
                    <div class="record-header">
                        <strong>Name ${id}</strong>
                        <button class="remove-button" onclick="removeRecord('name-record-${id}')">Remove</button>
                    </div>
                    <div class="two-column">
                        <div class="form-group">
                            <label>First Name</label>
                            <input type="text" id="name-first-${id}" placeholder="John">
                        </div>
                        <div class="form-group">
                            <label>Last Name</label>
                            <input type="text" id="name-last-${id}" placeholder="Doe">
                        </div>
                    </div>
                    <div class="two-column">
                        <div class="form-group">
                            <label>Middle Name</label>
                            <input type="text" id="name-middle-${id}" placeholder="Michael">
                        </div>
                        <div class="form-group">
                            <label>Prefix</label>
                            <input type="text" id="name-prefix-${id}" placeholder="Mr.">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Suffix</label>
                        <input type="text" id="name-suffix-${id}" placeholder="Jr.">
                    </div>
                </div>
            `;
            document.getElementById('name-section').insertAdjacentHTML('beforeend', html);
        }

        function addPhoneRecord() {
            const id = ++recordCounters.phone;
            const html = `
                <div class="record" id="phone-record-${id}">
                    <div class="record-header">
                        <strong>Phone ${id}</strong>
                        <button class="remove-button" onclick="removeRecord('phone-record-${id}')">Remove</button>
                    </div>
                    <div class="two-column">
                        <div class="form-group">
                            <label>Phone Number</label>
                            <input type="tel" id="phone-number-${id}" placeholder="+1-555-123-4567" 
                                   onblur="validatePhoneField(this)">
                        </div>
                        <div class="form-group">
                            <label>Type</label>
                            <select id="phone-type-${id}">
                                <option value="WORK">Work</option>
                                <option value="HOME">Home</option>
                                <option value="CELL">Mobile</option>
                                <option value="FAX">Fax</option>
                            </select>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('phone-section').insertAdjacentHTML('beforeend', html);
        }

        function addEmailRecord() {
            const id = ++recordCounters.email;
            const html = `
                <div class="record" id="email-record-${id}">
                    <div class="record-header">
                        <strong>Email ${id}</strong>
                        <button class="remove-button" onclick="removeRecord('email-record-${id}')">Remove</button>
                    </div>
                    <div class="two-column">
                        <div class="form-group">
                            <label>Email Address</label>
                            <input type="email" id="email-address-${id}" placeholder="john@example.com" 
                                   onblur="validateEmailField(this)">
                        </div>
                        <div class="form-group">
                            <label>Type</label>
                            <select id="email-type-${id}">
                                <option value="WORK">Work</option>
                                <option value="HOME">Home</option>
                                <option value="INTERNET">Internet</option>
                            </select>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('email-section').insertAdjacentHTML('beforeend', html);
        }

        function addAddressRecord() {
            const id = ++recordCounters.address;
            const html = `
                <div class="record" id="address-record-${id}">
                    <div class="record-header">
                        <strong>Address ${id}</strong>
                        <button class="remove-button" onclick="removeRecord('address-record-${id}')">Remove</button>
                    </div>
                    <div class="address-lookup">
                        <label>Address Lookup</label>
                        <input type="text" id="address-lookup-${id}" placeholder="Start typing an address..." 
                               onkeyup="handleAddressLookup(this, ${id})">
                        <div id="lookup-results-${id}" class="lookup-results" style="display: none;"></div>
                    </div>
                    <div class="two-column">
                        <div class="form-group">
                            <label>Street Address</label>
                            <input type="text" id="address-street-${id}" placeholder="123 Main St">
                        </div>
                        <div class="form-group">
                            <label>City</label>
                            <input type="text" id="address-city-${id}" placeholder="Anytown">
                        </div>
                    </div>
                    <div class="two-column">
                        <div class="form-group">
                            <label>State/Province</label>
                            <input type="text" id="address-state-${id}" placeholder="CA">
                        </div>
                        <div class="form-group">
                            <label>ZIP/Postal Code</label>
                            <input type="text" id="address-zip-${id}" placeholder="12345">
                        </div>
                    </div>
                    <div class="two-column">
                        <div class="form-group">
                            <label>Country</label>
                            <input type="text" id="address-country-${id}" placeholder="United States">
                        </div>
                        <div class="form-group">
                            <label>Type</label>
                            <select id="address-type-${id}">
                                <option value="WORK">Work</option>
                                <option value="HOME">Home</option>
                                <option value="POSTAL">Postal</option>
                            </select>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('address-section').insertAdjacentHTML('beforeend', html);
        }

        function addUrlRecord() {
            const id = ++recordCounters.url;
            const html = `
                <div class="record" id="url-record-${id}">
                    <div class="record-header">
                        <strong>Website ${id}</strong>
                        <button class="remove-button" onclick="removeRecord('url-record-${id}')">Remove</button>
                    </div>
                    <div class="two-column">
                        <div class="form-group">
                            <label>URL</label>
                            <input type="url" id="url-address-${id}" placeholder="https://example.com" 
                                   onblur="validateUrlField(this)">
                        </div>
                        <div class="form-group">
                            <label>Type</label>
                            <select id="url-type-${id}">
                                <option value="WORK">Work</option>
                                <option value="HOME">Home</option>
                                <option value="PERSONAL">Personal</option>
                            </select>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('url-section').insertAdjacentHTML('beforeend', html);
        }

        function addOrgRecord() {
            const id = ++recordCounters.org;
            const html = `
                <div class="record" id="org-record-${id}">
                    <div class="record-header">
                        <strong>Organization ${id}</strong>
                        <button class="remove-button" onclick="removeRecord('org-record-${id}')">Remove</button>
                    </div>
                    <div class="two-column">
                        <div class="form-group">
                            <label>Organization Name</label>
                            <input type="text" id="org-name-${id}" placeholder="Company Name">
                        </div>
                        <div class="form-group">
                            <label>Department</label>
                            <input type="text" id="org-department-${id}" placeholder="Department">
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('org-section').insertAdjacentHTML('beforeend', html);
        }

        function addTitleRecord() {
            const id = ++recordCounters.title;
            const html = `
                <div class="record" id="title-record-${id}">
                    <div class="record-header">
                        <strong>Title ${id}</strong>
                        <button class="remove-button" onclick="removeRecord('title-record-${id}')">Remove</button>
                    </div>
                    <div class="form-group">
                        <label>Job Title</label>
                        <input type="text" id="title-value-${id}" placeholder="Senior Developer">
                    </div>
                </div>
            `;
            document.getElementById('title-section').insertAdjacentHTML('beforeend', html);
        }

        function addNoteRecord() {
            const id = ++recordCounters.note;
            const html = `
                <div class="record" id="note-record-${id}">
                    <div class="record-header">
                        <strong>Note ${id}</strong>
                        <button class="remove-button" onclick="removeRecord('note-record-${id}')">Remove</button>
                    </div>
                    <div class="form-group">
                        <label>Note</label>
                        <textarea id="note-value-${id}" rows="3" placeholder="Additional notes..."></textarea>
                    </div>
                </div>
            `;
            document.getElementById('note-section').insertAdjacentHTML('beforeend', html);
        }

        function addNicknameRecord() {
            const id = ++recordCounters.nickname;
            const html = `
                <div class="record" id="nickname-record-${id}">
                    <div class="record-header">
                        <strong>Nickname ${id}</strong>
                        <button class="remove-button" onclick="removeRecord('nickname-record-${id}')">Remove</button>
                    </div>
                    <div class="form-group">
                        <label>Nickname</label>
                        <input type="text" id="nickname-value-${id}" placeholder="Brentster">
                    </div>
                </div>
            `;
            document.getElementById('nickname-section').insertAdjacentHTML('beforeend', html);
        }

        function addRoleRecord() {
            const id = ++recordCounters.role;
            const html = `
                <div class="record" id="role-record-${id}">
                    <div class="record-header">
                        <strong>Role ${id}</strong>
                        <button class="remove-button" onclick="removeRecord('role-record-${id}')">Remove</button>
                    </div>
                    <div class="form-group">
                        <label>Role</label>
                        <input type="text" id="role-value-${id}" placeholder="Edge-AI Solutions Architect">
                    </div>
                </div>
            `;
            document.getElementById('role-section').insertAdjacentHTML('beforeend', html);
        }

        function addCategoryRecord() {
            const id = ++recordCounters.category;
            const html = `
                <div class="record" id="category-record-${id}">
                    <div class="record-header">
                        <strong>Category ${id}</strong>
                        <button class="remove-button" onclick="removeRecord('category-record-${id}')">Remove</button>
                    </div>
                    <div class="form-group">
                        <label>Categories (comma-separated)</label>
                        <input type="text" id="category-value-${id}" placeholder="Technology,AI,Innovation">
                    </div>
                </div>
            `;
            document.getElementById('category-section').insertAdjacentHTML('beforeend', html);
        }

        function addPhotoRecord() {
            const id = ++recordCounters.photo;
            const html = `
                <div class="record" id="photo-record-${id}">
                    <div class="record-header">
                        <strong>Photo ${id}</strong>
                        <button class="remove-button" onclick="removeRecord('photo-record-${id}')">Remove</button>
                    </div>
                    <div class="two-column">
                        <div class="form-group">
                            <label>Photo Type</label>
                            <select id="photo-type-${id}">
                                <option value="URL">URL</option>
                                <option value="BASE64">Base64 Encoded</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Image Format</label>
                            <select id="photo-format-${id}">
                                <option value="JPEG">JPEG</option>
                                <option value="PNG">PNG</option>
                                <option value="GIF">GIF</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Photo Data</label>
                        <textarea id="photo-data-${id}" rows="3" placeholder="https://example.com/photo.jpg or base64 encoded data"></textarea>
                    </div>
                </div>
            `;
            document.getElementById('photo-section').insertAdjacentHTML('beforeend', html);
        }

        function addLogoRecord() {
            const id = ++recordCounters.logo;
            const html = `
                <div class="record" id="logo-record-${id}">
                    <div class="record-header">
                        <strong>Logo ${id}</strong>
                        <button class="remove-button" onclick="removeRecord('logo-record-${id}')">Remove</button>
                    </div>
                    <div class="form-group">
                        <label>Logo URL</label>
                        <input type="url" id="logo-url-${id}" placeholder="https://example.com/logo.jpg" onblur="validateUrlField(this)">
                    </div>
                </div>
            `;
            document.getElementById('logo-section').insertAdjacentHTML('beforeend', html);
        }

        function addSoundRecord() {
            const id = ++recordCounters.sound;
            const html = `
                <div class="record" id="sound-record-${id}">
                    <div class="record-header">
                        <strong>Sound ${id}</strong>
                        <button class="remove-button" onclick="removeRecord('sound-record-${id}')">Remove</button>
                    </div>
                    <div class="form-group">
                        <label>Sound URL</label>
                        <input type="url" id="sound-url-${id}" placeholder="https://example.com/pronunciation.wav" onblur="validateUrlField(this)">
                    </div>
                </div>
            `;
            document.getElementById('sound-section').insertAdjacentHTML('beforeend', html);
        }

        function addBdayRecord() {
            const id = ++recordCounters.bday;
            const html = `
                <div class="record" id="bday-record-${id}">
                    <div class="record-header">
                        <strong>Birthday ${id}</strong>
                        <button class="remove-button" onclick="removeRecord('bday-record-${id}')">Remove</button>
                    </div>
                    <div class="form-group">
                        <label>Birth Date</label>
                        <input type="date" id="bday-date-${id}">
                    </div>
                </div>
            `;
            document.getElementById('bday-section').insertAdjacentHTML('beforeend', html);
        }

        function addAnniversaryRecord() {
            const id = ++recordCounters.anniversary;
            const html = `
                <div class="record" id="anniversary-record-${id}">
                    <div class="record-header">
                        <strong>Anniversary ${id}</strong>
                        <button class="remove-button" onclick="removeRecord('anniversary-record-${id}')">Remove</button>
                    </div>
                    <div class="form-group">
                        <label>Anniversary Date</label>
                        <input type="date" id="anniversary-date-${id}">
                    </div>
                </div>
            `;
            document.getElementById('anniversary-section').insertAdjacentHTML('beforeend', html);
        }

        function addGenderRecord() {
            const id = ++recordCounters.gender;
            const html = `
                <div class="record" id="gender-record-${id}">
                    <div class="record-header">
                        <strong>Gender ${id}</strong>
                        <button class="remove-button" onclick="removeRecord('gender-record-${id}')">Remove</button>
                    </div>
                    <div class="form-group">
                        <label>Gender</label>
                        <select id="gender-value-${id}">
                            <option value="">Select Gender</option>
                            <option value="M">Male</option>
                            <option value="F">Female</option>
                            <option value="O">Other</option>
                            <option value="N">Not specified</option>
                        </select>
                    </div>
                </div>
            `;
            document.getElementById('gender-section').insertAdjacentHTML('beforeend', html);
        }

        function addImppRecord() {
            const id = ++recordCounters.impp;
            const html = `
                <div class="record" id="impp-record-${id}">
                    <div class="record-header">
                        <strong>IM Contact ${id}</strong>
                        <button class="remove-button" onclick="removeRecord('impp-record-${id}')">Remove</button>
                    </div>
                    <div class="two-column">
                        <div class="form-group">
                            <label>Service</label>
                            <select id="impp-service-${id}">
                                <option value="Skype">Skype</option>
                                <option value="Matrix">Matrix</option>
                                <option value="Discord">Discord</option>
                                <option value="Telegram">Telegram</option>
                                <option value="WhatsApp">WhatsApp</option>
                                <option value="Signal">Signal</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Username/Handle</label>
                            <input type="text" id="impp-handle-${id}" placeholder="username">
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('impp-section').insertAdjacentHTML('beforeend', html);
        }

        function addGeoRecord() {
            const id = ++recordCounters.geo;
            const html = `
                <div class="record" id="geo-record-${id}">
                    <div class="record-header">
                        <strong>Location ${id}</strong>
                        <button class="remove-button" onclick="removeRecord('geo-record-${id}')">Remove</button>
                    </div>
                    <div class="two-column">
                        <div class="form-group">
                            <label>Latitude</label>
                            <input type="number" id="geo-lat-${id}" placeholder="35.6528" step="any">
                        </div>
                        <div class="form-group">
                            <label>Longitude</label>
                            <input type="number" id="geo-lon-${id}" placeholder="-97.4781" step="any">
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('geo-section').insertAdjacentHTML('beforeend', html);
        }

        function addTzRecord() {
            const id = ++recordCounters.tz;
            const html = `
                <div class="record" id="tz-record-${id}">
                    <div class="record-header">
                        <strong>Time Zone ${id}</strong>
                        <button class="remove-button" onclick="removeRecord('tz-record-${id}')">Remove</button>
                    </div>
                    <div class="form-group">
                        <label>Time Zone Offset</label>
                        <input type="text" id="tz-value-${id}" placeholder="-05:00">
                    </div>
                </div>
            `;
            document.getElementById('tz-section').insertAdjacentHTML('beforeend', html);
        }

        function addKeyRecord() {
            const id = ++recordCounters.key;
            const html = `
                <div class="record" id="key-record-${id}">
                    <div class="record-header">
                        <strong>Encryption Key ${id}</strong>
                        <button class="remove-button" onclick="removeRecord('key-record-${id}')">Remove</button>
                    </div>
                    <div class="two-column">
                        <div class="form-group">
                            <label>Key Type</label>
                            <select id="key-type-${id}">
                                <option value="PGP">PGP</option>
                                <option value="GPG">GPG</option>
                                <option value="X509">X.509</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Encoding</label>
                            <select id="key-encoding-${id}">
                                <option value="b">Base64</option>
                                <option value="8bit">8bit</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Key Data</label>
                        <textarea id="key-data-${id}" rows="4" placeholder="Base64 encoded key data"></textarea>
                    </div>
                </div>
            `;
            document.getElementById('key-section').insertAdjacentHTML('beforeend', html);
        }

        // Color validation and preview functions
        function validateFaceColor() {
            const backingColor = document.getElementById('backing-color').value;
            const faceColor = document.getElementById('face-color').value;
            const errorDiv = document.getElementById('face-color-error');
            
            const backingBrightness = getBrightness(backingColor);
            const faceBrightness = getBrightness(faceColor);
            
            if (faceBrightness <= backingBrightness) {
                errorDiv.textContent = 'Face color must be brighter than backing color for QR code readability';
                errorDiv.style.display = 'block';
                document.getElementById('face-color').classList.add('invalid');
                return false;
            } else {
                errorDiv.style.display = 'none';
                document.getElementById('face-color').classList.remove('invalid');
                document.getElementById('face-color').classList.add('valid');
                updatePreview();
                return true;
            }
        }
        
        function getBrightness(hexColor) {
            // Convert hex to RGB
            const r = parseInt(hexColor.substr(1, 2), 16);
            const g = parseInt(hexColor.substr(3, 2), 16);
            const b = parseInt(hexColor.substr(5, 2), 16);
            
            // Calculate brightness using the standard formula
            return (r * 299 + g * 587 + b * 114) / 1000;
        }
        
        function updatePreview() {
            const backingColor = document.getElementById('backing-color').value;
            const faceColor = document.getElementById('face-color').value;
            const fontFamily = document.getElementById('font-family').value;
            const preview = document.getElementById('color-preview');
            
            preview.style.backgroundColor = backingColor;
            preview.style.color = faceColor;
            preview.style.fontFamily = fontFamily;
        }
        
        // Add event listeners for real-time preview updates
        document.addEventListener('DOMContentLoaded', function() {
            const backingColorInput = document.getElementById('backing-color');
            const faceColorInput = document.getElementById('face-color');
            const fontSelect = document.getElementById('font-family');
            
            backingColorInput.addEventListener('change', function() {
                validateFaceColor();
            });
            
            faceColorInput.addEventListener('change', validateFaceColor);
            fontSelect.addEventListener('change', updatePreview);
            
            // Initial preview update
            updatePreview();
        });

        function removeRecord(recordId) {
            document.getElementById(recordId).remove();
        }

        // Validation handlers
        function validatePhoneField(element) {
            const phone = element.value.trim();
            if (phone && !validatePhone(phone)) {
                showError(element, 'Invalid phone number format');
            } else if (phone) {
                showValid(element);
            }
        }

        function validateEmailField(element) {
            const email = element.value.trim();
            if (email && !validateEmail(email)) {
                showError(element, 'Invalid email address format');
            } else if (email) {
                showValid(element);
            }
        }

        function validateUrlField(element) {
            const url = element.value.trim();
            if (url && !validateUrl(url)) {
                showError(element, 'Invalid URL format');
            } else if (url) {
                showValid(element);
            }
        }

        // Address lookup handler
        function handleAddressLookup(element, recordId) {
            const query = element.value.trim();
            const resultsDiv = document.getElementById(`lookup-results-${recordId}`);
            
            if (query.length < 3) {
                resultsDiv.style.display = 'none';
                return;
            }
            
            lookupAddress(query, (results) => {
                resultsDiv.innerHTML = '';
                results.forEach(result => {
                    const item = document.createElement('div');
                    item.className = 'lookup-item';
                    item.textContent = result.formatted;
                    item.onclick = () => {
                        document.getElementById(`address-street-${recordId}`).value = result.street;
                        document.getElementById(`address-city-${recordId}`).value = result.city;
                        document.getElementById(`address-state-${recordId}`).value = result.state;
                        document.getElementById(`address-zip-${recordId}`).value = result.zip;
                        document.getElementById(`address-country-${recordId}`).value = result.country;
                        resultsDiv.style.display = 'none';
                    };
                    resultsDiv.appendChild(item);
                });
                resultsDiv.style.display = 'block';
            });
        }

        // vCard generation
        function generateVCard() {
            let vcard = 'BEGIN:VCARD\nVERSION:3.0\n';
            
            // Names
            for (let i = 1; i <= recordCounters.name; i++) {
                const record = document.getElementById(`name-record-${i}`);
                if (record) {
                    const first = document.getElementById(`name-first-${i}`).value;
                    const last = document.getElementById(`name-last-${i}`).value;
                    const middle = document.getElementById(`name-middle-${i}`).value;
                    const prefix = document.getElementById(`name-prefix-${i}`).value;
                    const suffix = document.getElementById(`name-suffix-${i}`).value;
                    
                    if (first || last) {
                        vcard += `N:${last};${first};${middle};${prefix};${suffix}\n`;
                        vcard += `FN:${prefix} ${first} ${middle} ${last} ${suffix}`.replace(/\s+/g, ' ').trim() + '\n';
                    }
                }
            }
            
            // Phones
            for (let i = 1; i <= recordCounters.phone; i++) {
                const record = document.getElementById(`phone-record-${i}`);
                if (record) {
                    const number = document.getElementById(`phone-number-${i}`).value;
                    const type = document.getElementById(`phone-type-${i}`).value;
                    if (number) {
                        vcard += `TEL;TYPE=${type}:${number}\n`;
                    }
                }
            }
            
            // Emails
            for (let i = 1; i <= recordCounters.email; i++) {
                const record = document.getElementById(`email-record-${i}`);
                if (record) {
                    const email = document.getElementById(`email-address-${i}`).value;
                    const type = document.getElementById(`email-type-${i}`).value;
                    if (email) {
                        vcard += `EMAIL;TYPE=${type}:${email}\n`;
                    }
                }
            }
            
            // Addresses
            for (let i = 1; i <= recordCounters.address; i++) {
                const record = document.getElementById(`address-record-${i}`);
                if (record) {
                    const street = document.getElementById(`address-street-${i}`).value;
                    const city = document.getElementById(`address-city-${i}`).value;
                    const state = document.getElementById(`address-state-${i}`).value;
                    const zip = document.getElementById(`address-zip-${i}`).value;
                    const country = document.getElementById(`address-country-${i}`).value;
                    const type = document.getElementById(`address-type-${i}`).value;
                    
                    if (street || city || state || zip || country) {
                        vcard += `ADR;TYPE=${type}:;;${street};${city};${state};${zip};${country}\n`;
                    }
                }
            }
            
            // URLs
            for (let i = 1; i <= recordCounters.url; i++) {
                const record = document.getElementById(`url-record-${i}`);
                if (record) {
                    const url = document.getElementById(`url-address-${i}`).value;
                    const type = document.getElementById(`url-type-${i}`).value;
                    if (url) {
                        vcard += `URL;TYPE=${type}:${url}\n`;
                    }
                }
            }
            
            // Organizations
            for (let i = 1; i <= recordCounters.org; i++) {
                const record = document.getElementById(`org-record-${i}`);
                if (record) {
                    const name = document.getElementById(`org-name-${i}`).value;
                    const department = document.getElementById(`org-department-${i}`).value;
                    if (name) {
                        vcard += `ORG:${name}`;
                        if (department) {
                            vcard += `;${department}`;
                        }
                        vcard += '\n';
                    }
                }
            }
            
            // Titles
            for (let i = 1; i <= recordCounters.title; i++) {
                const record = document.getElementById(`title-record-${i}`);
                if (record) {
                    const title = document.getElementById(`title-value-${i}`).value;
                    if (title) {
                        vcard += `TITLE:${title}\n`;
                    }
                }
            }
            
            // Notes
            for (let i = 1; i <= recordCounters.note; i++) {
                const record = document.getElementById(`note-record-${i}`);
                if (record) {
                    const note = document.getElementById(`note-value-${i}`).value;
                    if (note) {
                        vcard += `NOTE:${note}\n`;
                    }
                }
            }
            
            // Custom fields (product customizations)
            const customizations = {
                backingColor: document.getElementById('backing-color').value,
                faceColor: document.getElementById('face-color').value,
                fontFamily: document.getElementById('font-family').value
            };
            
            // Add customizations to vCard as custom fields
            vcard += `X-BACKING-COLOR:${customizations.backingColor}\n`;
            vcard += `X-FACE-COLOR:${customizations.faceColor}\n`;
            vcard += `X-FONT-FAMILY:${customizations.fontFamily}\n`;
            
            vcard += 'END:VCARD';
            
            // Display the vCard
            const outputDiv = document.getElementById('vcard-output');
            outputDiv.textContent = vcard;
            outputDiv.style.display = 'block';
            
            // Create a data structure for easy access
            const vcardData = {
                vcard: vcard,
                customizations: customizations,
                timestamp: new Date().toISOString()
            };
            
            // Store in a global variable for retrieval
            window.vcardData = vcardData;
            
            // Trigger custom event for integration
            window.dispatchEvent(new CustomEvent('vcardGenerated', { 
                detail: vcardData 
            }));
            
            // Scroll to output
            outputDiv.scrollIntoView({ behavior: 'smooth' });
        }
        
        // Utility function to get the vCard data
        function getVCardData() {
            return window.vcardData;
        }
        
        // Utility function to download vCard
        function downloadVCard() {
            if (!window.vcardData) {
                alert('Please generate a vCard first');
                return;
            }
            
            const blob = new Blob([window.vcardData.vcard], { type: 'text/vcard' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'contact.vcf';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // Add download button functionality
        document.addEventListener('DOMContentLoaded', function() {
            const generateSection = document.querySelector('.generate-section');
            const downloadBtn = document.createElement('button');
            downloadBtn.className = 'generate-button';
            downloadBtn.textContent = 'Download vCard';
            downloadBtn.onclick = downloadVCard;
            downloadBtn.style.marginLeft = '10px';
            generateSection.querySelector('.generate-button').insertAdjacentElement('afterend', downloadBtn);
        });
        
        // Hide lookup results when clicking outside
        document.addEventListener('click', function(event) {
            const lookupResults = document.querySelectorAll('.lookup-results');
            lookupResults.forEach(result => {
                if (!result.contains(event.target) && !event.target.id.includes('address-lookup')) {
                    result.style.display = 'none';
                }
            });
        });
        
        // Auto-save functionality (optional)
        function autoSave() {
            const formData = {};
            
            // Save all form fields
            document.querySelectorAll('input, select, textarea').forEach(field => {
                if (field.id) {
                    formData[field.id] = field.value;
                }
            });
            
            // Note: In a real Square site, you'd save this to your backend
            console.log('Auto-saved form data:', formData);
        }
        
        // Auto-save every 30 seconds
        setInterval(autoSave, 30000);
        
        // Initialize with at least one name field and setup customization listeners
        document.addEventListener('DOMContentLoaded', function() {
            addNameRecord();
            
            // Setup customization event listeners
            const backingColorInput = document.getElementById('backing-color');
            const faceColorInput = document.getElementById('face-color');
            const fontSelect = document.getElementById('font-family');
            
            if (backingColorInput) {
                backingColorInput.addEventListener('change', function() {
                    validateFaceColor();
                });
            }
            
            if (faceColorInput) {
                faceColorInput.addEventListener('change', validateFaceColor);
            }
            
            if (fontSelect) {
                fontSelect.addEventListener('change', updatePreview);
            }
            
            // Initial preview update
            setTimeout(updatePreview, 100);
        });
    </script>
</body>
</html>